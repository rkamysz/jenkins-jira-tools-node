!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=9)}([function(e,t){e.exports={happy:"( •‿•)⊃━☆ﾟ.*･｡ﾟ  ",crying:"( ಥ_ಥ)⊃━☆ﾟ.*･｡ﾟ  ",ups:"('⊙＿⊙)⊃━☆ﾟ.*･｡ﾟ  ",hurrah:"( ＾∇＾)⊃━☆ﾟ.*･｡ﾟ  ",focused:"(∩｀-´)⊃━☆ﾟ.*･｡ﾟ  "}},function(e,t,n){const o=n(6);e.exports.getVersionFromPackageJson=function(){var e=o.readFileSync("package.json","utf8");if(e){var t=JSON.parse(e),n=new RegExp("[^/]*$","g");return t.name.match(n)[0]+"@"+t.version}},e.exports.getFormatedDate=function(){var e=(new Date).toString().split(" ");return[e[2],e[1],e[3]].join("/")},e.exports.buildTransitionsRequestBody=function(e,t){var n={transition:{id:e}};return void 0!==t.assignee&&(n.fields||(n.fields={}),n.fields.assignee={name:t.assignee}),t.resolution&&(n.fields||(n.fields={}),n.fields.resolution={name:t.resolution}),t.comment&&(n.update||(n.update={}),n.update.comment=[{add:{body:t.comment}}]),JSON.stringify(n)}},function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("arkan.js")},function(e,t){e.exports=require("xml-parse")},function(e,t,n){const o=n(4),r=n(2),s=n(0);e.exports=function(e){if(!e)throw new Error("Missing jenkins config.");var t=e;return{getTicketsIds:function(){return console.log(s.focused+"find Jira tickets in Jenkins build log."),r(t.buildXMLUrl).then(e=>e.text()).then(e=>{var n=function(e){for(var t,n=0;n<e.length;n++)if("changeSet"===(t=e[n]).tagName)return t;return null}(o.parse(e)[0].childNodes);if(n){var r=function(e){for(var n,o,r,s=new RegExp(t.ticketIdPattern,"g"),i=[],a=0;a<e.length;a++){o=e[a];for(var c=0;c<o.childNodes.length;c++)"comment"===(r=o.childNodes[c]).tagName&&null!==(n=s.exec(r.innerXML))&&i.push(n[0])}return i}(n.childNodes);return console.log(s.happy+"Found "+r.length+" tickets"),r}return console.log(s.ups+"No tickets found"),[]}).catch(e=>(console.error(s.crying+e),[]))}}}},function(e,t){e.exports=require("fs")},function(e,t,n){const o=n(2),r=n(0),s=n(1).buildTransitionsRequestBody,i=n(1).getVersionFromPackageJson;e.exports=function(e){if(!e)throw new Error("Missing jira config.");var t=e,n={"Content-Type":"application/json",Authorization:"Basic "+Buffer.from(t.user+":"+t.password).toString("base64")};return{createVersion:function(e){return console.log(r.focused+"create new version in Jira"),e.project=e.project||t.project,e.name=e.name||i(),o(t.url+"/version",{method:"POST",headers:n,body:JSON.stringify(e)}).then(t=>{if(201!=t.status)throw new Error("status:"+t.status);return console.log(r.happy+"New version has been created "+e.name),t.json()}).then(e=>e.id).catch(t=>{console.log(r.crying+"Version "+e.name+" has not been added.",t)})},changeTicketFixVersion:function(e,s){return console.log(r.focused+"update fixVersions in Jira tickets"),o(t.url+"/issue/"+e,{method:"PUT",headers:n,body:'{"update":{"fixVersions":[{"add":{"id":"'+s+'"}}]}}'}).then(t=>{if(204!=t.status)throw new Error("status:"+t.status);console.log(r.happy+"Ticket "+e+" has been updated with new version "+s)}).catch(t=>{console.log(r.crying+"Ticket "+e+" has not been updated.",t)})},getAvailableTicketTransitions:function(e){return o(t.url+"/issue/"+e+"/transitions",{method:"GET",headers:n}).then(e=>{if(200!=e.status)throw new Error("status:"+e.status);return e.json()}).catch(e=>{console.log(r.crying+"I couldn't get transitions.",e)})},changeTicketTransitions:function(e,i,a){return console.log(r.focused+"change Jira ticket status"),o(t.url+"/issue/"+e+"/transitions",{method:"POST",headers:n,body:s(i,a)}).then(t=>{if(204!=t.status)throw new Error("status:"+t.status);console.log(r.happy+`Status of ${e} has been changed`)}).catch(t=>{console.log(r.crying+`Status of ${e} has not been changed.`,t)})},assignTicketTo:function(e,s){return console.log(r.focused+"assign Jira ticket to the user"),s||(s=""),o(t.url+"/issue/"+e,{method:"PUT",headers:n,body:'{"update":{"assignee":[{"set":{"name":"'+s+'"}}]}}'}).then(t=>{if(204!=t.status)throw new Error("status:"+t.status);console.log(r.happy+"Ticket "+e+" has been "+(s?"assigned to "+s:"unassigned"))}).catch(t=>{console.log(r.crying+"Ticket "+e+" has not been assigned.",t)})},addCommentToTicket:function(e,s){return console.log(r.focused+"add comment to the Jira ticket"),o(t.url+"/issue/"+e+"/comment",{method:"POST",headers:n,body:'{"body":"'+s+'"}'}).then(t=>{if(201!=t.status)throw new Error("status:"+t.status);console.log(r.happy+"Comment has been added to the ticket "+e)}).catch(t=>{console.log(r.crying+"Coment has not been added to the ticket "+e+".",t)})}}}},function(e,t,n){const o=n(0);e.exports=function(e){var t=n(7)(e.jira),r=n(5)(e.jenkins);return{findTickets:function(){return r.getTicketsIds()},createVersion:function(e){return t.createVersion(e)},updateFixVersions:function(e,n){return Promise.all(e.map(e=>t.changeTicketFixVersion(e,n)))},changeStatus:function(e,n){var r,s={};return"string"==typeof n?r=n:(r=n.status,Object.assign(s,n)),t.getAvailableTicketTransitions(e[0]).then(e=>{if(transition=e.transitions.find(e=>e.name.toLowerCase()===r.toLowerCase()),void 0===transition)throw new Error(o.ups+"I couldn't find status id for "+r)}).then(()=>Promise.all(e.map(e=>t.changeTicketTransitions(e,transition.id,s))))},assignTo:function(e,n){return Promise.all(e.map(e=>t.assignTicketTo(e,n)))},addComment:function(e,n){return Promise.all(e.map(e=>t.addCommentToTicket(e,n)))}}}},function(e,t,n){const o=n(3).Arkan,r=n(3).args,s=function(e){_app=n(8)(e),_arkan=new o};s.prototype.findTickets=function(e){return _arkan.run(_app.findTickets,[],"tickets").run(t=>{t.forEach(t=>{e.push(t)})},[r("tickets")]),this},s.prototype.createVersion=function(e,t){return _arkan.run(_app.createVersion,[e],"versionId").run(e=>{t(e)},[r("versionId")]),this},s.prototype.updateFixVersions=function(e,t){var n=!isNaN(parseFloat(t))&&isFinite(t);return _arkan.run(_app.updateFixVersions,[e,n?t:r("versionId")]),this},s.prototype.changeStatus=function(e,t){return _arkan.run(_app.changeStatus,[e,t]),this},s.prototype.assignTo=function(e,t){return _arkan.run(_app.assignTo,[e,t]),this},s.prototype.addComment=function(e,t){return _arkan.run(_app.addComment,[e,t]),this},e.exports=s}]);